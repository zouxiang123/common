<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xtt.common.dao.mapper.SysUserMapper" >
  <resultMap id="BaseResultMap" type="com.xtt.common.dao.model.SysUser" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 17 09:57:37 CST 2016.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="account" property="account" jdbcType="VARCHAR" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="initial" property="initial" jdbcType="VARCHAR" />
    <result column="password" property="password" jdbcType="VARCHAR" />
    <result column="image_path" property="imagePath" jdbcType="VARCHAR" />
    <result column="sex" property="sex" jdbcType="VARCHAR" />
    <result column="birthday" property="birthday" jdbcType="DATE" />
    <result column="position" property="position" jdbcType="VARCHAR" />
    <result column="mobile" property="mobile" jdbcType="VARCHAR" />
    <result column="sub_phone" property="subPhone" jdbcType="VARCHAR" />
    <result column="del_flag" property="delFlag" jdbcType="BIT" />
    <result column="fk_tenant_id" property="fkTenantId" jdbcType="INTEGER" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="create_user_id" property="createUserId" jdbcType="BIGINT" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="update_user_id" property="updateUserId" jdbcType="BIGINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 17 09:57:37 CST 2016.
    -->
    id, account, name, initial, password, image_path, sex, birthday, position, mobile, 
    sub_phone, del_flag, fk_tenant_id, create_time, create_user_id, update_time, update_user_id
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 17 09:57:37 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from sys_user
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 17 09:57:37 CST 2016.
    -->
    delete from sys_user
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.xtt.common.dao.model.SysUser" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 17 09:57:37 CST 2016.
    -->
    insert into sys_user (id, account, name, 
      initial, password, image_path, 
      sex, birthday, position, 
      mobile, sub_phone, del_flag, 
      fk_tenant_id, create_time, create_user_id, 
      update_time, update_user_id)
    values (#{id,jdbcType=BIGINT}, #{account,jdbcType=VARCHAR}, #{name,jdbcType=VARCHAR}, 
      #{initial,jdbcType=VARCHAR}, #{password,jdbcType=VARCHAR}, #{imagePath,jdbcType=VARCHAR}, 
      #{sex,jdbcType=VARCHAR}, #{birthday,jdbcType=DATE}, #{position,jdbcType=VARCHAR}, 
      #{mobile,jdbcType=VARCHAR}, #{subPhone,jdbcType=VARCHAR}, #{delFlag,jdbcType=BIT}, 
      #{fkTenantId,jdbcType=INTEGER}, #{createTime,jdbcType=TIMESTAMP}, #{createUserId,jdbcType=BIGINT}, 
      #{updateTime,jdbcType=TIMESTAMP}, #{updateUserId,jdbcType=BIGINT})
  </insert>
  <insert id="insertSelective" parameterType="com.xtt.common.dao.model.SysUser" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 17 09:57:37 CST 2016.
    -->
    insert into sys_user
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="account != null" >
        account,
      </if>
      <if test="name != null" >
        name,
      </if>
      <if test="initial != null" >
        initial,
      </if>
      <if test="password != null" >
        password,
      </if>
      <if test="imagePath != null" >
        image_path,
      </if>
      <if test="sex != null" >
        sex,
      </if>
      <if test="birthday != null" >
        birthday,
      </if>
      <if test="position != null" >
        position,
      </if>
      <if test="mobile != null" >
        mobile,
      </if>
      <if test="subPhone != null" >
        sub_phone,
      </if>
      <if test="delFlag != null" >
        del_flag,
      </if>
      <if test="fkTenantId != null" >
        fk_tenant_id,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="createUserId != null" >
        create_user_id,
      </if>
      <if test="updateTime != null" >
        update_time,
      </if>
      <if test="updateUserId != null" >
        update_user_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="account != null" >
        #{account,jdbcType=VARCHAR},
      </if>
      <if test="name != null" >
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="initial != null" >
        #{initial,jdbcType=VARCHAR},
      </if>
      <if test="password != null" >
        #{password,jdbcType=VARCHAR},
      </if>
      <if test="imagePath != null" >
        #{imagePath,jdbcType=VARCHAR},
      </if>
      <if test="sex != null" >
        #{sex,jdbcType=VARCHAR},
      </if>
      <if test="birthday != null" >
        #{birthday,jdbcType=DATE},
      </if>
      <if test="position != null" >
        #{position,jdbcType=VARCHAR},
      </if>
      <if test="mobile != null" >
        #{mobile,jdbcType=VARCHAR},
      </if>
      <if test="subPhone != null" >
        #{subPhone,jdbcType=VARCHAR},
      </if>
      <if test="delFlag != null" >
        #{delFlag,jdbcType=BIT},
      </if>
      <if test="fkTenantId != null" >
        #{fkTenantId,jdbcType=INTEGER},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createUserId != null" >
        #{createUserId,jdbcType=BIGINT},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUserId != null" >
        #{updateUserId,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.xtt.common.dao.model.SysUser" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 17 09:57:37 CST 2016.
    -->
    update sys_user
    <set >
      <if test="account != null" >
        account = #{account,jdbcType=VARCHAR},
      </if>
      <if test="name != null" >
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="initial != null" >
        initial = #{initial,jdbcType=VARCHAR},
      </if>
      <if test="password != null" >
        password = #{password,jdbcType=VARCHAR},
      </if>
      <if test="imagePath != null" >
        image_path = #{imagePath,jdbcType=VARCHAR},
      </if>
      <if test="sex != null" >
        sex = #{sex,jdbcType=VARCHAR},
      </if>
      <if test="birthday != null" >
        birthday = #{birthday,jdbcType=DATE},
      </if>
      <if test="position != null" >
        position = #{position,jdbcType=VARCHAR},
      </if>
      <if test="mobile != null" >
        mobile = #{mobile,jdbcType=VARCHAR},
      </if>
      <if test="subPhone != null" >
        sub_phone = #{subPhone,jdbcType=VARCHAR},
      </if>
      <if test="delFlag != null" >
        del_flag = #{delFlag,jdbcType=BIT},
      </if>
      <if test="fkTenantId != null" >
        fk_tenant_id = #{fkTenantId,jdbcType=INTEGER},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createUserId != null" >
        create_user_id = #{createUserId,jdbcType=BIGINT},
      </if>
      <if test="updateTime != null" >
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUserId != null" >
        update_user_id = #{updateUserId,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.xtt.common.dao.model.SysUser" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jun 17 09:57:37 CST 2016.
    -->
    update sys_user
    set account = #{account,jdbcType=VARCHAR},
      name = #{name,jdbcType=VARCHAR},
      initial = #{initial,jdbcType=VARCHAR},
      password = #{password,jdbcType=VARCHAR},
      image_path = #{imagePath,jdbcType=VARCHAR},
      sex = #{sex,jdbcType=VARCHAR},
      birthday = #{birthday,jdbcType=DATE},
      position = #{position,jdbcType=VARCHAR},
      mobile = #{mobile,jdbcType=VARCHAR},
      sub_phone = #{subPhone,jdbcType=VARCHAR},
      del_flag = #{delFlag,jdbcType=BIT},
      fk_tenant_id = #{fkTenantId,jdbcType=INTEGER},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      create_user_id = #{createUserId,jdbcType=BIGINT},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      update_user_id = #{updateUserId,jdbcType=BIGINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
	
	<!-- 自定义 -->
	<resultMap id="ExtendResultMap" extends="BaseResultMap" type="com.xtt.common.dao.po.SysUserPO">
	  <result column="roleId" property="roleId" jdbcType="VARCHAR" />
	  <result column="roleName" property="roleName" jdbcType="VARCHAR" />
	  <result column="last_step" property="lastStep" jdbcType="INTEGER" />
	</resultMap>
	<select id="searchPersonByName" parameterType="java.lang.Integer" resultMap="ExtendResultMap">
		SELECT
			p.id, p.name, '患者' roleName,ifnull(dc.last_step,pd.last_step) last_step, p.image_path
		FROM
			patient p
			left join dialysis_campaign dc on p.id=dc.fk_patient_id and dc.end_flag != 1 and p.fk_tenant_id=dc.fk_tenant_id
			left join patient_diagnosis pd on p.id=pd.fk_patient_id and pd.is_draft = 1 and p.fk_tenant_id=pd.fk_tenant_id
		where p.fk_tenant_id=#{tenantId}
	      <if test="name != null" >
	      	and p.name like CONCAT('%', #{name}, '%')
	      </if>
		union all
		SELECT
			u.id, u.name, '医生' roleName,null, u.image_path
		FROM
			sys_user u inner join sys_user2role ur on u.id=ur.fk_user_id
			inner join sys_role r on ur.fk_role_id=r.id and r.parent_id=2
		where u.fk_tenant_id=#{tenantId} AND u.del_flag=0
	      <if test="name != null" >
	      	and u.name like CONCAT('%', #{name}, '%')
	      </if>
		union all
		SELECT
			u.id, u.name, '护士' roleName,null, u.image_path
		FROM
			sys_user u inner join sys_user2role ur on u.id=ur.fk_user_id
			inner join sys_role r on ur.fk_role_id=r.id and r.parent_id=3
		where u.fk_tenant_id=#{tenantId} AND u.del_flag=0
	      <if test="name != null" >
	      	and u.name like CONCAT('%', #{name}, '%')
	      </if>

	</select>

	<select id="selectByParentRoleIds" resultMap="ExtendResultMap">
		SELECT u.*,sr.parent_id as parentRoleId FROM sys_user u
		JOIN sys_user2role su ON su.fk_user_id = u.id
		JOIN sys_role sr ON sr.id = su.fk_role_id
		WHERE u.fk_tenant_id =#{tenantId,jdbcType=INTEGER}
		AND u.del_flag=0
		AND sr.parent_id in 
		<foreach collection="roleIds" item="item" index="index" open="(" separator="," close=")">
			#{item}
		</foreach>
		GROUP BY u.id
		ORDER BY u.initial ASC;
	</select>
	
	<select id="selectPOById" parameterType="java.lang.Long" resultMap="ExtendResultMap">
		SELECT
	    	u.id, u.account, u.name, u.initial, u.password, u.image_path, u.sex, u.birthday, u.position, u.mobile, 
	    	u.sub_phone, u.del_flag, u.fk_tenant_id, u.create_time, u.create_user_id, u.update_time, u.update_user_id, 
	    	GROUP_CONCAT(sr.fk_role_id) AS roleId,GROUP_CONCAT(r.parent_id) AS parentRoleId
		FROM
			sys_user u
		JOIN sys_user2role sr ON sr.fk_user_id = u.id
		JOIN sys_role r ON sr.fk_role_id = r.id
		WHERE
			u.id = #{id,jdbcType=BIGINT}
	</select>
	
	<select id="selectAllUserByTenantId" parameterType="java.lang.Integer" resultMap="ExtendResultMap">
		SELECT
			u.id,u.account,u.birthday,u.mobile,u.`name`,u.sub_phone,GROUP_CONCAT(r.`name`) as roleName
		FROM
			sys_user u
		JOIN sys_user2role sr ON sr.fk_user_id = u.id
		JOIN sys_role r ON sr.fk_role_id = r.id
		where u.fk_tenant_id=#{tenantId,jdbcType=INTEGER}
		AND u.del_flag=0
		GROUP BY u.id,u.account,u.birthday,u.mobile,u.`name`,u.sub_phone
		ORDER BY u.id ASC
	</select>
	
	<select id="selectUserWithFilter" parameterType="com.xtt.common.dao.po.SysUserPO" resultMap="ExtendResultMap">
		SELECT
			u.id,u.account,u.birthday,u.mobile,u.`name`,u.sub_phone,GROUP_CONCAT(r.`name`) as roleName
		FROM
			sys_user u
		JOIN sys_user2role sr ON sr.fk_user_id = u.id
		JOIN sys_role r ON sr.fk_role_id = r.id
		where u.fk_tenant_id=#{fkTenantId,jdbcType=INTEGER} AND u.del_flag=0
		<if test="account != null and account != ''" >
			and u.account like CONCAT("%",#{account,jdbcType=VARCHAR},"%")
		</if>
		<if test="name != null and name != ''" >
			and u.name like CONCAT("%",#{name,jdbcType=VARCHAR},"%")
		</if>
		<if test="mobile != null and mobile != ''" >
			and u.mobile like CONCAT("%",#{mobile,jdbcType=VARCHAR},"%")
		</if>
		GROUP BY u.id,u.account,u.birthday,u.mobile,u.`name`,u.sub_phone
		ORDER BY u.id ASC
	</select>
	
	<select id="selectUserByAccount" resultMap="BaseResultMap">
		select * from sys_user 
		where del_flag=0
		and account=#{account,jdbcType=VARCHAR} 
		and fk_tenant_id=#{tenantId,jdbcType=INTEGER}
	</select>
	
	<select id="login" resultMap="ExtendResultMap">
		select u.*,group_concat(r.id) as roleId,group_concat(r.parent_id) as parentRoleId
		from sys_user u inner join sys_user2role ur on u.id=ur.fk_user_id
		inner join sys_role r on ur.fk_role_id = r.id
		where u.del_flag=0
		and u.account=#{account,jdbcType=VARCHAR} 
		and u.password=#{password,jdbcType=VARCHAR} 
		and u.fk_tenant_id=#{tenantId,jdbcType=INTEGER}
	</select>
	
	<select id="selectRolesCount" parameterType="java.lang.Integer" resultType="map">
		SELECT count(DISTINCT u.id) AS count,sr.parent_id AS roleType FROM sys_user u
		JOIN sys_user2role su ON su.fk_user_id = u.id
		JOIN sys_role sr ON sr.id = su.fk_role_id
		WHERE u.del_flag=0
		AND u.fk_tenant_id =#{tenantId,jdbcType=INTEGER}
		GROUP BY sr.parent_id
	</select>
	
	<update id="updatePassword">
		update sys_user set password = #{password} where id= #{id}
	</update>
</mapper>